from datetime import datetime
from multiprocessing import Value

from odoo import models, fields, api


class Categories(models.Model):
    _name = 'ozon.categories'
    _description = 'Категории Ozon'

    name_categories = fields.Char(string='Наименование категории')
    insurance = fields.Float(string='Страховой коэффициент, %')


class GraphSaleThisYear(models.Model):
    _inherit = 'ozon.categories'

    img_url_sale_this_year = fields.Char(string="Ссылка на объект")
    img_html_sale_this_year = fields.Html(
        compute="_compute_img_sale_this_year",
        string="График продаж за текущий год"
    )

    def _compute_img_sale_this_year(self):
        for rec in self:
            rec.img_html_sale_this_year = False
            if not rec.img_url_sale_this_year: continue

            rec.img_html_sale_this_year = (
                f"<img src='{rec.img_url_sale_this_year}' width='600'/>"
            )


class GraphSaleLastYear(models.Model):
    _inherit = 'ozon.categories'

    img_url_sale_last_year = fields.Char(string="Ссылка на объект")
    img_html_sale_last_year = fields.Html(
        compute="_compute_img_sale_last_year",
        string="График продаж за прошлый год"
    )

    def _compute_img_sale_last_year(self):
        for rec in self:
            rec.img_html_sale_last_year = False
            if not rec.img_url_sale_last_year: continue

            rec.img_html_sale_last_year = (
                f"<img src='{rec.img_url_sale_last_year}' width='600'/>"
            )


class GraphInterest(models.Model):
    _inherit = 'ozon.categories'

    img_url_analysis_data_this_year = fields.Char(string="Ссылка на объект")
    img_html_analysis_data_this_year = fields.Html(
        compute="_compute_img_analysis_data_this_year",
        string="График интереса тукущий год"
    )

    def _compute_img_analysis_data_this_year(self):
        for rec in self:
            rec.img_html_analysis_data_this_year = False
            if not rec.img_url_analysis_data_this_year: continue

            rec.img_html_analysis_data_this_year = (
                f"<img src='{rec.img_url_analysis_data_this_year}' width='600'/>"
            )


class ActionGraphs(models.Model):
    _inherit = 'ozon.categories'

    def action_draw_graphs(self):
        self.draw_sale_this_year()
        self.draw_sale_last_year()
        self.draw_graph_interest()

    def draw_sale_this_year(self):
        pass

    def draw_sale_last_year(self):
        pass

    def draw_graph_interest(self):
        model_products = self.env["ozon.products"]
        model_analysis_data = self.env["ozon.analysis_data"]
        year = self._get_year()

        data_for_send = {}

        for categorie_record in self:
            data_categorie = data_for_send[categorie_record.id] = {}

            products_records = model_products.search([
                ("categories", "=", categorie_record.id),
                ("is_alive", "=", True),
                ("is_selling", "=", True),
            ])

            for product_record in products_records:

                analysis_data_records = model_analysis_data.search([
                    ("product", "=", product_record.id),
                    ("timestamp_from", ">=", f"{year}-01-01"),
                    ("timestamp_to", "<=", f"{year}-12-31"),
                ])

                if not analysis_data_records: continue

                graph_data = {"dates": [], "num": []}

                for analysis_data_record in analysis_data_records:
                    start_date = analysis_data_record.timestamp_from
                    end_date = analysis_data_record.timestamp_to
                    average_date = start_date + (end_date - start_date) / 2

                    graph_data["dates"].append(average_date.strftime("%Y-%m-%d"))
                    graph_data["num"].append(analysis_data_record.hits_view)

                data_categorie[product_record.id] = graph_data

        data_for_send = {11: {634: {'dates': ['2024-01-18', '2024-01-19', '2024-01-20'], 'num': [2, 2, 2]}, 829: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [37, 39, 41, 41, 42, 38, 40, 38, 38]}, 831: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [159, 148, 155, 149, 140, 140, 151, 138, 157]}, 832: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [2, 2, 2, 3]}, 834: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [521, 504, 481, 482, 461, 393, 385, 379, 327]}, 837: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [83, 85, 96, 101, 103, 115, 119, 120, 121]}, 839: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [90, 106, 128, 136, 151, 175, 188, 198, 182]}, 841: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [33, 30, 27, 25, 11, 11, 10]}, 843: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [75, 69, 73, 69, 79, 82, 80, 80, 81]}, 844: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [28, 28, 28, 27, 16, 16, 22]}, 963: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [79, 81, 77, 79, 64, 59, 58, 47, 49]}, 1043: {'dates': ['2024-01-14', '2024-01-15', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [10, 12, 12, 13, 9]}, 1044: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [6, 6, 7, 5]}, 1069: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [47, 40, 38, 34, 31, 31, 29, 31, 36]}, 1070: {'dates': ['2024-01-18', '2024-01-19', '2024-01-20'], 'num': [1, 1, 1]}, 1072: {'dates': ['2024-01-14'], 'num': [3]}, 1074: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [1, 1, 2, 2]}, 1076: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [36, 30, 28, 28, 26, 26, 25, 22]}, 1078: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [11, 14, 17, 18, 16, 16]}, 1080: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [58, 53, 43, 44, 45, 48, 52, 52, 55]}, 1880: {'dates': ['2024-01-19', '2024-01-20'], 'num': [2, 2]}, 1882: {'dates': ['2024-01-14', '2024-01-18'], 'num': [1, 1]}, 1887: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [2, 2, 2, 1]}, 4397: {'dates': ['2024-01-13', '2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [18, 12, 12, 10, 10]}, 4400: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [18, 14, 16, 16, 17, 16]}, 4461: {'dates': ['2024-01-14', '2024-01-18'], 'num': [2, 2]}, 4462: {'dates': ['2024-01-18', '2024-01-19', '2024-01-20'], 'num': [1, 1, 1]}, 5743: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [3, 4, 4, 4]}, 5744: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [59, 49, 49, 51, 52, 48, 47, 40, 35]}, 5747: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [730, 709, 723, 711, 706, 668, 637, 606, 618]}, 6067: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [106, 110, 107, 104, 88, 92, 94, 87, 78]}, 6068: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [31, 26, 26, 27, 26, 26, 24, 33, 33]}, 6142: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [40, 38, 40, 30, 27, 31, 34, 34, 36]}, 10755: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [172, 161, 181, 171, 154, 132, 110, 93, 89]}, 10756: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [65, 60, 48, 54, 49, 55, 55, 63, 79]}, 10757: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [26, 26, 27, 27, 24, 24, 26, 27]}, 10979: {'dates': ['2024-01-13', '2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [8, 9, 6, 6, 7]}, 10980: {'dates': ['2024-01-13', '2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [8, 9, 8, 12, 10]}, 10981: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [138, 139, 139, 139, 140, 130, 138, 134, 128]}, 14445: {'dates': ['2024-01-18', '2024-01-19', '2024-01-20'], 'num': [3, 3, 3]}, 14446: {'dates': ['2024-01-14'], 'num': [1]}, 14448: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [1, 2, 3, 3]}, 14573: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [68, 70, 68, 67, 62, 66, 73, 73, 66]}, 14574: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [2, 1, 1, 1]}, 14580: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [1, 1, 2, 1]}, 14582: {'dates': ['2024-01-19', '2024-01-20'], 'num': [2, 3]}, 14585: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [3, 2, 2, 2]}, 14589: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19'], 'num': [2, 1, 1]}, 14591: {'dates': ['2024-01-14', '2024-01-19', '2024-01-20'], 'num': [1, 2, 2]}, 14592: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19'], 'num': [1, 1, 1]}, 14593: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [13, 20, 25, 21, 21, 24, 23, 23]}, 14594: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [94, 81, 71, 71, 68, 80, 89, 83, 73]}, 14598: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19'], 'num': [1, 1, 1]}, 14602: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [44, 37, 33, 32, 27, 27, 28, 25]}, 14603: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [40, 31, 32, 28, 32, 31, 32, 31, 32]}, 14604: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19'], 'num': [1, 1, 1]}, 14607: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [2, 2, 2, 2]}, 14610: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [14, 12, 17, 19, 22, 21]}, 14731: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [63, 56, 57, 60, 56, 60, 54, 48, 43]}, 14736: {'dates': ['2024-01-14'], 'num': [2]}, 14737: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [54, 59, 64, 68, 76, 76, 74, 79, 76]}, 16636: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [22, 20, 14, 5, 6, 7]}, 16646: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [25, 25, 25, 21, 21, 17]}, 16649: {'dates': ['2024-01-20'], 'num': [1]}, 16654: {'dates': ['2024-01-14'], 'num': [5]}, 16656: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [1, 1, 1, 1]}, 16661: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [2, 2, 3, 4]}, 16812: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [10, 8, 13, 21, 20, 19]}, 16813: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [639, 647, 671, 653, 627, 574, 565, 578, 568]}, 16902: {'dates': ['2024-01-13', '2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [10, 5, 4, 3, 2]}, 16905: {'dates': ['2024-01-18', '2024-01-19', '2024-01-20'], 'num': [1, 1, 1]}, 16907: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [123, 125, 129, 119, 109, 104, 100, 94, 82]}, 16909: {'dates': ['2024-01-14', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [3, 2, 3, 1]}, 16910: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [78, 68, 65, 89, 85, 79, 90, 92, 92]}, 16913: {'dates': ['2024-01-20'], 'num': [2]}, 17247: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-18', '2024-01-19', '2024-01-20'], 'num': [14, 11, 13, 15, 10, 11]}, 17248: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [47, 43, 42, 43, 49, 48, 51, 57, 55]}, 17249: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [86, 91, 91, 97, 88, 93, 95, 86, 85]}, 17250: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [67, 86, 98, 124, 134, 145, 154, 145, 129]}, 17251: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [1372, 1472, 1442, 1314, 1105, 1001, 894, 761, 503]}, 17252: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [455, 488, 542, 567, 604, 754, 853, 876, 940]}, 17253: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [136, 114, 113, 119, 110, 106, 102, 100, 103]}, 17254: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [199, 220, 221, 250, 259, 274, 270, 262, 257]}, 17255: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [90, 93, 87, 80, 66, 66, 61, 67, 69]}, 17256: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [257, 265, 262, 281, 276, 263, 239, 248, 247]}, 17257: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [1573, 1540, 1587, 1540, 1521, 1553, 1518, 1563, 1552]}, 17258: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [1049, 988, 863, 772, 680, 669, 649, 615, 580]}, 17259: {'dates': ['2024-01-13', '2024-01-14', '2024-01-15', '2024-01-16', '2024-01-17', '2024-01-18', '2024-01-19', '2024-01-20', '2024-01-21'], 'num': [17, 18, 22, 28, 28, 27, 30, 31, 33]}}}

        raise ValueError(data_for_send)
    
    def _get_year(self) -> str:
        return datetime.now().year
    
class NameGetCustom(models.Model):
    _inherit = 'ozon.categories'

    def name_get(self):
        """
        Rename name records 
        """
        result = []
        for record in self:
            result.append((record.id, record.name_categories))
        return result